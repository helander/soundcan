#!/bin/sh

gcc /usr/src/lv2soundfont/soundfont_presets.c -lfluidsynth -o /usr/bin/soundfont_presets

for sf in $(ls /soundfonts)
do
    SOUNDFONT=$(basename $sf)

    mkdir -p /usr/lib/lv2/${SOUNDFONT}.lv2
    ln -s /soundfonts/${SOUNDFONT} /usr/lib/lv2/${SOUNDFONT}.lv2/soundfont.sf2	
    sed "s/FOOBAR/${SOUNDFONT}/" /usr/src/lv2soundfont/soundfont.c  > /usr/lib/lv2/${SOUNDFONT}.lv2/soundfont.c
    gcc /usr/lib/lv2/${SOUNDFONT}.lv2/soundfont.c -DPIC -fPIC  -lfluidsynth -shared -o /usr/lib/lv2/${SOUNDFONT}.lv2/soundfont.so
    rm /usr/lib/lv2/${SOUNDFONT}.lv2/soundfont.c

    sed "s/xLABELx/${SOUNDFONT}/" /usr/src/lv2soundfont/soundfont.ttl.in1  > /usr/lib/lv2/${SOUNDFONT}.lv2/soundfont.ttl
    cd /usr/lib/lv2/${SOUNDFONT}.lv2 && soundfont_presets 2>/dev/null                                         >> /usr/lib/lv2/${SOUNDFONT}.lv2/soundfont.ttl
    sed "s/xLABELx/${SOUNDFONT}/" /usr/src/lv2soundfont/soundfont.ttl.in2 >> /usr/lib/lv2/${SOUNDFONT}.lv2/soundfont.ttl

    sed "s/xLABELx/${SOUNDFONT}/" /usr/src/lv2soundfont/manifest.ttl.in > /usr/lib/lv2/${SOUNDFONT}.lv2/manifest.ttl

done
